<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="../pixi.min.js"></script>
    <script src="../bump.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        .box {
            margin: 0 auto;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body onload="init();">
    <div id="box" class="box"></div>
</body>
    <script type="text/javascript">
        function keyboard(keyCode) {
            let key = {};
            key.code = keyCode;
            key.isDown = false;
            key.isUp = true;
            key.press = undefined;
            key.release = undefined;
            //The `downHandler`
            key.downHandler = event => {
                if (event.keyCode === key.code) {
                    if (key.isUp && key.press) key.press();
                    key.isDown = true;
                    key.isUp = false;
                }
                event.preventDefault();
            };
            //The `upHandler`
            key.upHandler = event => {
                if (event.keyCode === key.code) {
                    if (key.isDown && key.release) key.release();
                    key.isDown = false;
                    key.isUp = true;
                }
                event.preventDefault();
            };
            //Attach event listeners
            window.addEventListener(
                "keydown", key.downHandler.bind(key), false
            );
            window.addEventListener(
                "keyup", key.upHandler.bind(key), false
            );
            return key;
        }
        function init() {
            let type = "WebGL"
            if (!PIXI.utils.isWebGLSupported()) {
                type = "canvas"
            }
            PIXI.utils.sayHello(type);

            let b = new Bump(PIXI), //碰撞偵測
            money,
            moneys,
            count_money = 0,        //計算得分
            screenWidth = window.innerWidth,    //螢幕寬
            screenHeight = window.innerHeight,  //螢幕高
            playerMoveSpeed = 10,               //玩家鍵盤速度
            app = new PIXI.Application({
                width: screenWidth,
                height: screenHeight,
                antialias: true,    // default: false
                transparent: false, // default: false
                resolution: 1       // default: 1
            });
            app.renderer.backgroundColor = 0xde54a9;
            document.getElementById('box').appendChild(app.view);
            PIXI.loader
                .add([
                    "../images/bunny.png",
                    "../images/money.png"
                ])
                .on("progress", loadProgressHandler)
                .load(setup);
            function loadProgressHandler(loader, resource) {
                console.log("loading: " + resource.url);
                console.log("progress: " + loader.progress + "%");
            }
            function setup() {
                var playerTexture = PIXI.Texture.from("../images/bunny.png");
                player = new PIXI.Sprite(playerTexture);
                player.circular = true;
                player.width = 80;
                player.height = 80;
                player.position.x = (screenWidth - 80) / 2;
                player.position.y = screenHeight - 80 - 20;
                player.vx = 0;
                player.vy = 0;
                player.interactive = true;
                player.buttonMode = true;
                player.dragging = false;
                player.on('pointerdown', onDragStart)
                player.on('pointermove', onDragMove)
                player.on('pointerup', onDragEnd)
                player.on('pointerupoutside', onDragEnd);


								//顯示賺了多少錢
                const style = new PIXI.TextStyle({
                    fontSize: 20,
                    fill: "white"
                });
                numberText = new PIXI.Text('0',style);
                numberText.position.x = 30;
                numberText.position.y = 30;
                app.stage.addChild(numberText);

                //錢錢
                moneyTexture = PIXI.Texture.from("../images/money.png");
                //錢錢容器
                moneys = new PIXI.Container();
                app.stage.addChild(moneys);
                //錢錢容器的x軸
                moneys.x = screenWidth < 480 ? 0 : ((screenWidth - 600)/2)

                app.stage.addChild(player);
                //鍵盤事件
                var left = keyboard(37);
                var up = keyboard(38);
                var right = keyboard(39);
                var down = keyboard(40);
                left.press = () => {
                    player.vx = -playerMoveSpeed;
                    player.vy = 0;
                };
                left.release = () => {
                    player.vx = 0;
                    player.vy = 0;
                };

                right.press = () => {
                    player.vx = playerMoveSpeed;
                    player.vy = 0;
                };
                right.release = () => {
                    player.vx = 0;
                    player.vy = 0;
                };

                //創建錢錢的time
                create_money_time=0;

                requestAnimationFrame(update);
            }

            function r(min, max) {
                return Math.floor(Math.random() * (max - min)) + min
            }

            function getRandomInt(min, max) {
              min = Math.ceil(min);
              max = Math.floor(max);
              return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
            }

            function update() {
                player.position.x += player.vx;
                player.position.y += player.vy;

                //避免超出畫布
                if(player.position.x<=0){
                   player.position.x=0;
                }
                if(player.position.x>=screenWidth-player.width){
                   player.position.x=screenWidth-player.width;
                }
                if(player.position.y<=0){
                   player.position.y=0;
                }
                if(player.position.y>=screenHeight-player.height){
                   player.position.y=screenHeight-player.height;
                }

                //產生很多的錢錢
                moneys.children.forEach(obj => {
                    obj.position.y += getRandomInt(2,6);
                    if (obj.position.y >= screenHeight) {
                        moneys.removeChild(obj);
                    }
                    //碰撞检测
                    if (b.hitTestCircle(obj, player, true)) {
                        moneys.removeChild(obj);
                        count_money += 1
												numberText.text=count_money;
                    }
                });

                //每隔一段时间，增加一個錢錢
                create_money_time++;
                if (create_money_time >= 50) {
                    money = new PIXI.Sprite(moneyTexture);
                    money.width = 50;
                    money.height = 50;
                    money.position.x = r(0, 512);
                    money.position.y = 0;
                    money.circular = true;
                    moneys.addChild(money);
                    create_money_time = 0;
                }

                requestAnimationFrame(update);
            }

            function onDragStart(e) {
              player.x = e.data.global.x - player.width/2;
              player.dragging = true;
            }

            function onDragMove(e) {
              if (player.dragging) {
                player.x = e.data.global.x - player.width/2;
              }
            }

            function onDragEnd(e) {
              player.x = e.data.global.x - player.width/2;
              player.dragging = false;
            }
        }
    </script>
</html>