<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubao小遊戲</title>
    <script src="../pixi.min.js"></script>
    <script src="../bump.js"></script>
    <!-- use pixi-legacy for unsupported webGL's phone ex: Samsung GALAXY J7
    <script src="../pixi-legacy.min.js"></script>
    -->
    <style>
        * {
          margin: 0;
          padding: 0;
        }

        .box {
          margin: 0 auto;
          width: 100%;
          height: 100%;
        }

        .info {
          top: 60px;
          left: 30px;
          position: absolute;
          color: white;
        }

        #accelPermsButton {
          position: absolute;
          display: none;
          top: 30px;
          left: calc((100% - 140px) /2);
          width: 140px;
          font-size: 13px;
        }

        #logText {
          height: 150px;
          overflow-y: scroll;
        }
    </style>
</head>
<body onload="init();">
    <div id="box" class="box"></div>
    <button id="accelPermsButton" onclick="getAccel()">取得手機陀螺儀授權</button>
    <div class="info">
      alpha:<span id="alpha"></span><br/>
      beta:<span id="beta"></span><br/>
      gamma:<span id="gamma"></span><br/>
      方向:<span id="dirText"></span><br/>
      速度:<span id="speedText"></span><br/>
      版本:<span id="version">1.17</span><br/>
      log:<span id="logText"></span><br/>
    </div>
</body>
    <script type="text/javascript">
        let bubaoSp,              //布寶實體物件
          bubaoMobileSpeed = 2.5, //布寶手機陀螺儀控制移動速度
          old_alpha = 0,
          old_gamma = 0,
          delta = 0,
          BUBAO_SCALE = 0.5;

        function getAccel() {
          if(window.DeviceOrientationEvent) {
            DeviceMotionEvent.requestPermission().then(response => {
              if (response == 'granted') {
                document.getElementById('accelPermsButton').style.display = 'none';
                window.addEventListener('deviceorientation', function(event) {
                  var a = document.getElementById('alpha'),
                      b = document.getElementById('beta'),
                      g = document.getElementById('gamma'),
                      dirText = document.getElementById('dirText'),
                      speedText = document.getElementById('speedText'),
                      logText = document.getElementById('logText'),
                      alpha = Math.round(event.alpha),
                      beta = Math.round(event.beta),
                      gamma = Math.round(event.gamma);

                  a.innerHTML = alpha;
                  b.innerHTML = beta;
                  g.innerHTML = gamma;

                  if(gamma - old_gamma > 0) {
                    dirText.innerHTML = '右';
                    bubaoSp.setDirection('right')
                  } else if (gamma - old_gamma < 0) {
                    dirText.innerHTML = '左';
                    bubaoSp.setDirection('left')
                  }

                  if (gamma == old_gamma){
                    bubaoSp.vx += 0;
                    bubaoSp.stop();
                  } else if (gamma != old_gamma){
                    bubaoSp.vx += (gamma - old_gamma) / bubaoMobileSpeed;
                    bubaoSp.play();
                  }

                  old_alpha = alpha;
                  old_gamma = gamma;

                  delta =  (gamma - old_gamma);
                  logText.innerHTML = 'delta: ' + delta + '</br>'

                }, false);
              }
            });
          }
        }
        function keyboard(keyCode) {
          let key = {};
          key.code = keyCode;
          key.isDown = false;
          key.isUp = true;
          key.press = undefined;
          key.release = undefined;
          //The `downHandler`
          key.downHandler = event => {
            if (event.keyCode === key.code) {
                if (key.isUp && key.press) key.press();
                key.isDown = true;
                key.isUp = false;
            }
            event.preventDefault();
          };
          //The `upHandler`
          key.upHandler = event => {
            if (event.keyCode === key.code) {
              if (key.isDown && key.release) key.release();
              key.isDown = false;
              key.isUp = true;
            }
            event.preventDefault();
          };
          //Attach event listeners
          window.addEventListener(
            "keydown", key.downHandler.bind(key), false
          );
          window.addEventListener(
            "keyup", key.upHandler.bind(key), false
          );
          return key;
        }
        function isMobileDevice() {
          const mobileDevice = ['Android', 'webOS', 'iPhone', 'iPad', 'iPod', 'BlackBerry', 'Windows Phone']
          let isMobileDevice = mobileDevice.some(e => navigator.userAgent.match(e))
          return isMobileDevice
        }
        function init() {
          if (isMobileDevice()) {
            //顯示取得手機陀螺儀授權按鈕
            document.getElementById('accelPermsButton').style.display = 'block';
          }
          let type = "WebGL"
          if (!PIXI.utils.isWebGLSupported()) {
              type = "canvas"
          }
          PIXI.utils.sayHello(type);

          let b = new Bump(PIXI), //碰撞偵測
          money,
          moneys,
          count_money = 0,        //計算得分
          screenWidth = window.innerWidth,    //螢幕寬
          screenHeight = window.innerHeight,  //螢幕高
          bubaoKeyboardSpeed = 10,               //玩家鍵盤速度
          bubao_old_x = 0,
          app = new PIXI.Application({
            width: screenWidth,
            height: screenHeight,
            antialias: true,    // default: false
            transparent: false, // default: false
            resolution: 1       // default: 1
          });
          app.renderer.backgroundColor = 0xde54a9;
          document.getElementById('box').appendChild(app.view);

          PIXI.loader
            .add([
                "../images/bubao_1.png",
                "../images/bubao_2.png",
                "../images/bubao_3.png",
                "../images/bubao_4.png",
                "../images/point.png"
            ])
            .on("progress", loadProgressHandler)
            .load(setup);
          function loadProgressHandler(loader, resource) {
            console.log("loading: " + resource.url);
            console.log("progress: " + loader.progress + "%");
          }
          function setup() {
            //建立布寶動畫
            CreateAnimatedSp();

            //顯示賺了多少錢
            const style = new PIXI.TextStyle({
              fontSize: 20,
              fill: "white"
            });
            numberText = new PIXI.Text('0',style);
            numberText.position.x = 30;
            numberText.position.y = 30;
            app.stage.addChild(numberText);

            //錢錢
            moneyTexture = PIXI.Texture.from("../images/point.png");
            //錢錢容器
            moneys = new PIXI.Container();
            app.stage.addChild(moneys);
            //錢錢容器的x軸
            moneys.x = screenWidth < 480 ? 0 : ((screenWidth - 600)/2)

            //鍵盤事件
            var left = keyboard(37);
            var up = keyboard(38);
            var right = keyboard(39);
            var down = keyboard(40);
            left.press = () => {
              bubaoSp.vx = - bubaoKeyboardSpeed;
              bubaoSp.vy = 0;
              bubaoSp.setDirection('left')
              bubaoSp.play();
            };
            left.release = () => {
              bubaoSp.vx = 0;
              bubaoSp.vy = 0;
              bubaoSp.stop();
            };

            right.press = () => {
              bubaoSp.vx = bubaoKeyboardSpeed;
              bubaoSp.vy = 0;
              bubaoSp.setDirection('right')
              bubaoSp.play();
            };
            right.release = () => {
              bubaoSp.vx = 0;
              bubaoSp.vy = 0;
              bubaoSp.stop();
            };

            //創建錢錢的time
            create_money_time=0;

            requestAnimationFrame(update);
          }

          function r(min, max) {
            return Math.floor(Math.random() * (max - min)) + min
          }

          function update() {
            bubaoSp.position.x += bubaoSp.vx;
            bubaoSp.position.y += bubaoSp.vy;

            //避免超出畫布
            if (bubaoSp.position.x <= 0) {
              bubaoSp.position.x = bubaoSp.width/2;
            }
            if (bubaoSp.position.x >= screenWidth) {
              bubaoSp.position.x = screenWidth-bubaoSp.width/2;
            }
            if (bubaoSp.position.y <=0 ) {
              bubaoSp.position.y = 0;
            }
            if (bubaoSp.position.y >= screenHeight-bubaoSp.height) {
              bubaoSp.position.y=screenHeight-bubaoSp.height;
            }

            //錢錢forEach處理
            moneys.children.forEach(obj => {
              obj.position.y += 4;
              if (obj.position.y >= screenHeight) {
                  moneys.removeChild(obj);
              }
              //碰撞检测
              if (b.hitTestCircle(obj, bubaoSp, true)) {
                  moneys.removeChild(obj);
                  count_money += 1
                  numberText.text=count_money;
              }
            });

            //每隔一段时间，增加一個錢錢
            create_money_time++;
            if (create_money_time >= 50) {
              money = new PIXI.Sprite(moneyTexture);
              money.width = 50;
              money.height = 50;
              money.position.x = r(0, 512);
              money.position.y = 0;
              money.circular = true;
              moneys.addChild(money);
              create_money_time = 0;
            }

            requestAnimationFrame(update);
          }

          function onDragStart(e) {
            bubaoSp.x = e.data.global.x - bubaoSp.width/2;
            bubaoSp.dragging = true;
            bubaoSp.play();
          }

          function onDragMove(e) {
            if (bubaoSp.dragging) {
              bubaoSp.x = e.data.global.x - bubaoSp.width/2;
              if (bubao_old_x -  e.data.global.x > 0) {
                bubaoSp.setDirection('left')
              } else {
                bubaoSp.setDirection('right')
              }
              bubao_old_x = e.data.global.x;
            }
          }

          function onDragEnd(e) {
            bubaoSp.x = e.data.global.x - bubaoSp.width/2;
            bubaoSp.dragging = false;
            bubaoSp.stop();
          }

          function CreateAnimatedSp() {
            let bubaoImages = ["../images/bubao_1.png","../images/bubao_2.png","../images/bubao_3.png","../images/bubao_4.png"];
            let textureArray = [];

            for (let i=0; i < bubaoImages.length; i++)
            {
              let texture = PIXI.Texture.from(bubaoImages[i]);
              textureArray.push(texture);
            };

            bubaoSp = new PIXI.AnimatedSprite(textureArray);

            app.stage.addChild(bubaoSp);

            bubaoSp.anchor.x = 0.5;
            bubaoSp.circular = true;
            bubaoSp.width = 120;
            bubaoSp.height = 120;
            bubaoSp.position.x = (screenWidth - 120) / 2;
            bubaoSp.position.y = screenHeight - 120 - 20;
            bubaoSp.vx = 0;
            bubaoSp.vy = 0;
            bubaoSp.interactive = true;
            bubaoSp.buttonMode = true;
            bubaoSp.dragging = false;
            bubaoSp.on('pointerdown', onDragStart)
            bubaoSp.on('pointermove', onDragMove)
            bubaoSp.on('pointerup', onDragEnd)
            bubaoSp.on('pointerupoutside', onDragEnd);
            bubaoSp.setDirection = function(dir) {
              if (dir === 'left') {
                bubaoSp.scale.x = BUBAO_SCALE * -1
              } else {
                bubaoSp.scale.x = BUBAO_SCALE * 1
              }
            }
            app.ticker.add((delta) => {
              bubaoSp.animationSpeed = 0.2
            })

          }

        }
    </script>
</html>